<html>
<head>
<script type="text/javascript" src="scripts/jquery-3.3.1.min.js">
</script>
	
<script> 
/* *** Доступные функции *** 
addText(text) - добавляет текст в текстовую область
function changeStatus(param,stat) - изменение параметров статуса игрока. param: 0 здоровье, 1 положение тела. stat - bodyStatus
check_actions() - обновить кнопки игрока
check_roomObjects() - обновить кнопки комнаты

use_object(id,element) - вызывается для использования объекта. id вызывающей кнопки, DOM объект
use_item(id,element) - вызывается для использования предмета


*/


var game_url = 'https://samosborthegame.github.io/main/';

document.oncontextmenu = function (){return false};

// указатель на текущую объект-комнату
var currentRoom;

var getButtonByName = function(obj,name) { // это сервисная функция она везде одинакова
  for (var i = 0; i < obj.buttons.length; i++) {
    var button = obj.buttons[i];
    if (button['name'] == name) {
      return button;
    }
  }
}

// вот этот вот объект НЕ меняется по ходу написания сценария и не повторяется, он един для всех комнат написан заранее. это как бы "движок" игры:
var gameView = {
  previousRoom : {},
  awaiting_clicks : 0,
  click_buffer : [],
  showText : function(txt) {
  	$('#actualText').append('<br>'+txt);
	if (typeof(document.getElementById("actualText")) != 'undefined') {
			t_scroll = document.getElementById("actualText").scrollHeight
	}

	$('#actualText').scrollTop(t_scroll);
  },
  execute : function(cmd) {
    console.log('executing: ' + cmd);
  	this.awaiting_clicks = 0;
    this.click_buffer = [];
    $('#cmd').fadeOut(1000);
    var validAction = currentRoom.actions.hasOwnProperty(cmd);
    this.showText('<i>&gt;' + cmd + '</i>');
    if (!validAction) {
    	this.showText('What?'); // это реакция на действие которое не было прописано в комнате
    } else {
    	this.showText(currentRoom.actions[cmd](currentRoom)); // вызов имеющейся реакции
    }
    this.rebuild();
  },
  clicked : function(name) {
    $('#cmd').fadeIn(500);
  	console.log(name + ' clicked');
    this.click_buffer.push(name);
    var command = this.click_buffer.join(' ');
    $('#cmd').text(command);
    var butt = getButtonByName(currentRoom,name);
    if (--this.awaiting_clicks <= 0) {
    	if (butt.chain_length == 0) {
      	this.execute(command);
      } else {
 				this.awaiting_clicks = butt.chain_length;
        this.click_buffer = [butt.name];
		    $('#cmd').text(butt.name);
      }
    }
  },
	rebuild : function() {
    console.log('rebuilding...');
    if (this.previousRoom != currentRoom) {
     this.previousRoom = currentRoom;
     this.showText(currentRoom.getDescription(currentRoom));
    }
    $('#playerActions').empty();
		for (var i = 0; i < currentRoom.buttons.length; i++) {
      var butt = currentRoom.buttons[i];
      if (!butt.hasOwnProperty('chain_length'))
      	butt.chain_length = 0;
      if (!butt.hasOwnProperty('visible'))
      	butt.visible = true;
      if (!butt.visible) continue;
      var btn = $('<button class="button">'+butt.name+'</button>');
    	$('#playerActions').append(btn);
      if (butt.chain_length == 0) btn.css('background', 'yellow');
      else if (butt.chain_length == 1) btn.css('background', 'orange');
      else if (butt.chain_length == 2) btn.css('background', 'green');
      if (butt.hasOwnProperty('highlight') && butt.highlight) btn.css('background', 'salmon');
      var _this = this;
      btn.click(function(){
      	_this.clicked($(this).text());
      });
    }
  }
}

function gameInterface(room) {

	var main_w = $('#main-div');
	if (room.roomImg != "undefined") main_w.css("background-image" , "url("+room.roomImg+")");
	
	//блоки интерфейса
	var room_title = document.createElement('div');
	room_title.id = 'room_title';
	main_w.append(room_title);
	if (room.roomTitle != "undefined") room_title.innerHTML = room.roomTitle;
	
	var room_image = document.createElement('div');
	room_image.id = 'room_image';
	main_w.append(room_image);
	
	var room_image_padding = document.createElement('div');
	room_image_padding.id = 'room_image_padding';
	room_image.append(room_image_padding);
	
	var room_textArea = document.createElement('div');
	room_textArea.id = 'room_textArea';
	room_image.append(room_textArea);
	
		var actualText_back = document.createElement('div');
		actualText_back.id = 'actualText_back';
		room_textArea.append(actualText_back);
		
		var actualText = document.createElement('div');
		actualText.id = 'actualText';
		//actualText.innerHTML = room.getDescription() + '<br>';
		room_textArea.append(actualText);
		
		var playerStatus_back = document.createElement('div');
		playerStatus_back.id = 'playerStatus_back';
		room_textArea.append(playerStatus_back);
		
		var playerStatus = document.createElement('div');
		playerStatus.id = 'playerStatus';
		room_textArea.append(playerStatus);
			
			var namePlayerStatus = document.createElement('div');
			namePlayerStatus.id = 'namePlayerStatus';
			//namePlayerStatus.innerHTML = room.player.name;
			playerStatus.append(namePlayerStatus);
			
			var healthPlayerStatus = document.createElement('div');
			healthPlayerStatus.id = 'healthPlayerStatus';
			//healthPlayerStatus.innerHTML = room.player.health +"%";
			playerStatus.append(healthPlayerStatus);
			
			var bodyPlayerStatus = document.createElement('div');
			bodyPlayerStatus.id = 'bodyPlayerStatus';
			//bodyPlayerStatus.innerHTML = room.player.bodyStatus[room.player.currentBodyStatus];
			playerStatus.append(bodyPlayerStatus);
			
	var room_actions = document.createElement('div');
	room_actions.id = 'room_actions';
	room_image.append(room_actions);
		
		var playerActions = document.createElement('div');
		playerActions.id = 'playerActions';
		room_actions.append(playerActions);
		
		var roomActions = document.createElement('div');
		roomActions.id = 'roomActions';
		room_actions.append(roomActions);
		
		var playerItems = document.createElement('div');
		playerItems.id = 'playerItems';
		room_actions.append(playerItems);
	
		var cmd = document.createElement('div');
		cmd.id = 'cmd';
		room_actions.append(cmd);
}


// а это объект-комната таких объектов будет много на каждую комнату объект
var room1 = {
  roomId : 1,
  roomImg : 'img/back/lol5.png',
  roomTitle : 'Клетка Сыча',
  // это просто чтобы держать состояния комнаты вместе
  flags : {
  	door_opened : false
  },
  // здесь описываются кнопки
	buttons : [
    { name : 'убить', // название кнопки
      visible : true, // изначальная видимость
    	chain_length : 2 }, // количество кнопок которые надо будет нажать после
    { name : 'дед',
      visible : true,
    	chain_length : 0 },
    { name : 'нож',
      visible : true,
    	chain_length : 0 },
  	{ name : 'open',
      visible : true,
    	chain_length : 1 },
    { name : 'door',
      visible : true,
    	chain_length : 0 },
    { name : 'exit room',
      visible : false,
    	chain_length : 0 },
  ],
  getDescription : function(room) { // эта функция возвращает текст который будет показан при заходе в комнату. здесь можно проверить/установить флаги перед показом текста
  	return 'This is an exampe room.'
  },
  // а здесь прописываются реакции на действия
  actions : {
    'убить дед нож' : function(room) { return 'Вы убили деда ножом!' }, // каждая реакция возвращает текст для показа
    'убить нож дед' : function(room) { return 'Вы убили нож дедом!' },
  	'open door' : 
      function(room) { // и кроме возвращения текста может проверять флаги, устанавливать флаги, менять видимост кнопок и многое другое, например сменить текущий currentRoom на что-то другое
      	if (room.flags.door_opened) {
        	return 'Already opened!';
        } else {
        	room.flags.door_opened = true;
          getButtonByName(room, 'exit room').visible = true; // пример когда меняется видимость кнопке
          return 'You\'ve opened the door!';
        }
    },
    'exit room' : function(room) { currentRoom = room2; return 'You win!'; }
  }
}

var room2 = {
  roomId : 2,
	flags : {},
  buttons : [
  	{ name : 'нечего нажимать', highlight : true } // по умолчанию chain_length будет 0, а visible будет true. highlight можно использовать для односложных действий чтобы отличать это от предметов (дед vs блевануть)
  ],
  getDescription : function(room) { return 'Вы в комнате победителя.' },
  actions : {  'нечего нажимать' : function() { return 'Сказано же, нечего нажимать!' }}
}

var roomArray = [
	room1, room2
]

var saveGame = function(){
  var roomId = currentRoom.roomId;
	var save = { 'array' : roomArray, 'roomId' : roomId };
  var saveTxt = JSON.stringify(save);
  console.log('saving ' + saveTxt);
  localStorage.setItem("samosbor_save", saveTxt);
}

var loadGame = function(){
  var savedTxt = localStorage.getItem("samosbor_save");
  if (savedTxt != undefined) {
    console.log('loading ' + savedTxt);
  	var obj = JSON.parse(savedTxt);
    for (var i = 0; i < roomArray.length; i++) {
    	if (roomArray[i].roomId == obj.roomId) {
      	currentRoom = roomArray[i];
      }
      roomArray[i].flags = obj.array[i].flags;
      roomArray[i].buttons = obj.array[i].buttons;
    }
    gameView.rebuild();
	}
	
}

function new_game() {
	document.getElementById("main-menu").style.display = "none";
	
	//Создаем нового игрока
	
	//Запускаем игрока в комнату
	currentRoom = room1;
	gameInterface(currentRoom);
	gameView.rebuild();
	//soundPlayer(samosbor_intro);
}

var music_played = 0;
function soundPlayer (name) {
	
console.log(name);	
	if (name == null) {
		if (music_played == 1) {
			music_played = 0;
			audio.pause();
			$("#musicButton").html('Музыка &#9658');	

		}
		else {
			audio.play();
			music_played = 1;
			$("#musicButton").html('Музыка &#9209');	
		}
	}
	else {
		audio.preload = 'auto';
		audio.src = 'audio/'+name+'.mp3';
		audio.play();
		music_played = 1;
		$("#musicButton").html('Музыка &#9209');	
	}
}
var audio = new Audio();
soundPlayer('samosbor_intro');


//С этой части документа начинает вторая версия написания игры использую загрузку данных из json

</script>
<title>ВНИМАНИЕ НАЧИНАЕТСЯ САМОСБОР</title>
<link rel="stylesheet" href="css/minetheme.css">
</head>
<body>

<div id="main-div" ondblclick="" onselectstart="return false" onmousedown="return false">
	<ul id="system_menu" class="button">
		<li class="button"> <a href=# onClick="saveGame()">Сохранить игру</a></li>
		<li class="button"> <a href=# onClick="loadGame()">Загрузить игру</a></li>
		<li class="button"> <a id="musicButton" href=# onClick="soundPlayer(null)">Музыка &#9658;</a></li>
		<li class="button"> <a href=''>Выход в главное меню </a></li>
	</ul>
	<div id="main-menu">
		<div class="button" onClick="new_game()">Новая игра</div>
		<div class="button" onClick="start_level('load_test')">Лаборатория САМОСБОРА</div>
		<!--<a class="a_button" onClick="load_game()" href="#">Загрузить игру</a>-->
	</div>
</div>

</body>
</html>
